# Dataset Uploader для TARGControl

## Описание

**Dataset Uploader** — это веб-приложение на базе **Streamlit**, предназначенное для автоматизации создания и отправки датасетов в систему TARGControl через её API. Приложение позволяет загружать Excel-файлы с данными о продукции, локациях и навыках, проверять их корректность и отправлять в TARGControl для создания датасетов с дневными и/или ночными шаблонами.

### Основные функции
- Загрузка Excel-файла с данными о продукции, локациях и навыках.
- Валидация структуры файла (обязательные столбцы: `Продукция`, `Локация`).
- Проверка названий локаций и навыков на соответствие данным из API TARGControl.
- Настройка временных интервалов для одного (дневного) или двух (дневного и ночного) шаблонов.
- Автоматическая генерация и отправка датасетов через API TARGControl.
- Отображение прогресс-бара и сообщений об ошибках/успехе.

## Требования

Для работы приложения необходимы:
- **Python**: 3.13 (или 3.12, если есть проблемы с совместимостью библиотек).
- **Docker**: 20.10+ и **Docker Compose**: 1.29+ для контейнеризации.
- Зависимости, перечисленные в `requirements.txt`:
  ```
  altair>=5.0.0
  attrs>=25.0.0
  blinker>=1.9.0
  cachetools>=5.0.0
  certifi>=2024.0.0
  charset-normalizer>=3.0.0
  click>=8.0.0
  colorama>=0.4.0
  et_xmlfile>=1.1.0
  gitdb>=4.0.0
  GitPython>=3.1.0
  idna>=3.0.0
  Jinja2>=3.1.0
  jsonschema>=4.0.0
  jsonschema-specifications>=2023.0.0
  MarkupSafe>=2.0.0
  narwhals>=1.0.0
  numpy>=2.0.0
  openpyxl>=3.1.0
  packaging>=24.0
  pandas>=2.0.0
  pillow>=10.0.0
  protobuf>=5.0.0
  pyarrow>=14.0.0
  pydeck>=0.9.0
  python-dateutil>=2.8.0
  pytz>=2024.0
  referencing>=0.30.0
  requests>=2.32.0
  rpds-py>=0.20.0
  six>=1.16.0
  smmap>=5.0.0
  streamlit>=1.46.0
  tenacity>=9.0.0
  toml>=0.10.0
  tornado>=6.0.0
  typing_extensions>=4.0.0
  tzdata>=2024.0
  urllib3>=2.0.0
  watchdog>=5.0.0
  ```

## Установка

### Локальная установка
1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/your-repository/dataset-uploader.git
   cd dataset-uploader
   ```
2. Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Для Windows: venv\Scripts\activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
4. Запустите приложение:
   ```bash
   streamlit run app.py
   ```

### Установка с использованием Docker
1. Убедитесь, что Docker и Docker Compose установлены:
   ```bash
   docker --version
   docker-compose --version
   ```
2. Клонируйте репозиторий (если ещё не сделано):
   ```bash
   git clone https://github.com/your-repository/dataset-uploader.git
   cd dataset-uploader
   ```
3. Убедитесь, что файлы `Dockerfile`, `docker-compose.yml`, `app.py` и `requirements.txt` находятся в корневой директории.
4. Соберите и запустите контейнер:
   ```bash
   docker-compose up --build
   ```
5. Приложение будет доступно по адресу `http://localhost:8501`.
6. Для остановки контейнера используйте:
   ```bash
   docker-compose down
   ```

## Использование

1. Запустите приложение локально (`streamlit run app.py`) или через Docker (`docker-compose up --build`).
2. Откройте браузер и перейдите по адресу `http://localhost:8501`.
3. Введите действительный API-токен TARGControl в поле ввода.
4. Загрузите Excel-файл, соответствующий описанной ниже структуре.
5. Выберите количество шаблонов (1 или 2) и задайте временные интервалы для дневного и (при необходимости) ночного шаблона.
6. Выберите метрику из списка, полученного из TARGControl.
7. Нажмите кнопку **Обработать файл** для обработки и отправки датасетов.

### Структура Excel-файла
Файл должен содержать следующие столбцы:
- **Продукция**: Название продукта (например, "Продукт А").
- **Локация**: Название локации, точно совпадающее с данными в TARGControl (например, "Линия 1").
- **Описание** (необязательно): Код номенклатуры или описание продукта. Если не заполнено, используется "Датасет для [Продукция]".
- **Навыки**: Столбцы с названиями навыков, соответствующими данным TARGControl (например, "Навык1", "Навык2"). Значения — целые числа или пустые ячейки.

**Пример таблицы**:

| Продукция   | Локация   | Описание     | Навык1 | Навык2 |
|-------------|-----------|--------------|--------|--------|
| Продукт А   | Линия 1   | NOM12345     | 5      | 3      |
| Продукт Б   | Линия 2   |              | 2      | 0      |

**Требования к файлу**:
- Обязательные столбцы: `Продукция`, `Локация`.
- Названия локаций и навыков должны **точно** совпадать с данными API TARGControl.
- Значения навыков — целые числа или пустые ячейки.
- Формат файла: `.xlsx`.

### Важные замечания
- Время окончания дневного шаблона не должно быть позже времени начала ночного шаблона (при использовании двух шаблонов).
- API-токен должен быть действительным и иметь доступ к `cloud.targcontrol.com`.
- Метрики и шаблоны должны быть предварительно созданы в веб-интерфейсе TARGControl.

## Структура проекта
```
dataset-uploader/
├── app.py               # Основной файл приложения Streamlit
├── requirements.txt     # Список зависимостей
├── Dockerfile           # Файл для сборки Docker-образа
├── docker-compose.yml   # Конфигурация Docker Compose
└── README.md            # Документация
```

### Dockerfile
```dockerfile
# Используем официальный образ Python 3.13
FROM python:3.13-slim

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем файлы requirements.txt и приложение
COPY requirements.txt .
COPY app.py .

# Обновляем pip и устанавливаем зависимости
RUN pip install --upgrade pip && pip install --no-cache-dir -r requirements.txt

# Открываем порт для Streamlit
EXPOSE 8501

# Команда для запуска Streamlit
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

### docker-compose.yml
```yaml
version: '3.9'
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8501:8501"
    volumes:
      - .:/app
    environment:
      - PYTHONUNBUFFERED=1
```

## Устранение неисправностей

1. **Ошибка при чтении Excel-файла**:
   - Убедитесь, что файл имеет формат `.xlsx` и содержит обязательные столбцы (`Продукция`, `Локация`).
   - Проверьте, что названия столбцов совпадают с ожидаемыми (без лишних пробелов или ошибок).

2. **Локация или навыки не найдены**:
   - Проверьте список доступных локаций и навыков в интерфейсе приложения (выводится после ввода API-токена).
   - Убедитесь, что названия в Excel-файле точно совпадают с данными API TARGControl.

3. **Ошибка API**:
   - Проверьте валидность API-токена.
   - Убедитесь, что сервер `cloud.targcontrol.com` доступен.

4. **Ошибки при сборке Docker-образа**:
   - Если библиотеки несовместимы с Python 3.13, замените `FROM python:3.13-slim` на `FROM python:3.12-slim` в `Dockerfile`.
   - Проверьте логи сборки:
     ```bash
     docker-compose up --build
     ```
   - Если ошибка связана с конкретной библиотекой, попробуйте ослабить версии в `requirements.txt` (например, `altair>=5.0.0` вместо `altair==5.5.0`).

5. **Отсутствуют метрики или шаблоны**:
   - Создайте метрики и шаблоны в веб-интерфейсе TARGControl перед использованием приложения.

6. **Проблемы с Docker**:
   - Убедитесь, что Docker и Docker Compose установлены и их версии совместимы с `version: '3.9'`:
     ```bash
     docker --version
     docker-compose --version
     ```
   - Если приложение не открывается по `http://localhost:8501`, проверьте, что порт 8501 не занят другим процессом:
     ```bash
     netstat -tuln | grep 8501  # Linux
     netstat -aon | findstr 8501  # Windows
     ```
